"use strict";(self.webpackChunkstrapi=self.webpackChunkstrapi||[]).push([[7382],{77382:(Z,L,e)=>{e.r(L),e.d(L,{default:()=>me});var s=e(74081),d=e(1180),f=e(49402),y=e(44328),p=e(10701),D=e(21395),E=e(77970),P=e(93415),C=e(23298),u=e(28502),T=e(5938),R=e(6918),A=e(15244),U=e(86967),c=e(93153),B=e(50086),Y=e(4987),J=e(8295),G=e(61121),X=e(27997),$=e(74758),w=e(73354),k=e(27875),q=e(37472),v=e(61020),ee=e(79211),Q=e(40464),se=e(51447),te=e(11266),ae=e(89486),ne=e(82298),n=e(70627),ie=e(33866),oe=e(98264),ue=e(27279),ge=e(64797),Ee=e(85811),ce=e(92401),pe=e(15816),Me=e(97442),De=e(13576),Pe=e(87830),Oe=e(47184),Le=e(364),fe=e(71563),ye=e(49204),Ce=e(47853),Te=e(75719),he=e(74919),Re=e(29206),Ae=e(98934),Ue=e(43433),ve=e(8175);const re=({canReadAuditLogs:t,canReadUsers:l})=>{const{get:m}=(0,d.useFetchClient)(),{search:i}=(0,se.TH)(),_=(0,d.useNotification)(),[{query:r}]=(0,d.useQueryParams)(),a={keepPreviousData:!0,retry:!1,staleTime:1e3*20,onError:M=>_({type:"warning",message:M.message})},{users:o,isError:g,isLoading:O}=(0,te.u)({},{...a,enabled:l,staleTime:2*(1e3*60)}),{data:h,isLoading:j,isError:W}=(0,Q.useQuery)(["auditLogs",i],async()=>{const{data:M}=await m("/admin/audit-logs",{params:r});return M},{...a,enabled:t});return{auditLogs:h,users:o,isLoading:O||j,hasError:W||g}},V=()=>{const{formatDate:t}=(0,v.Z)();return m=>{const i=(0,ie.Z)(m),_=t(i,{dateStyle:"long"}),r=t(i,{timeStyle:"medium",hourCycle:"h24"});return`${_}, ${r}`}},z={"entry.create":"Create entry{model, select, undefined {} other { ({model})}}","entry.update":"Update entry{model, select, undefined {} other { ({model})}}","entry.delete":"Delete entry{model, select, undefined {} other { ({model})}}","entry.publish":"Publish entry{model, select, undefined {} other { ({model})}}","entry.unpublish":"Unpublish entry{model, select, undefined {} other { ({model})}}","media.create":"Create media","media.update":"Update media","media.delete":"Delete media","media-folder.create":"Create media folder","media-folder.update":"Update media folder","media-folder.delete":"Delete media folder","user.create":"Create user","user.update":"Update user","user.delete":"Delete user","admin.auth.success":"Admin login","admin.logout":"Admin logout","content-type.create":"Create content type","content-type.update":"Update content type","content-type.delete":"Delete content type","component.create":"Create component","component.update":"Update component","component.delete":"Delete component","role.create":"Create role","role.update":"Update role","role.delete":"Delete role","permission.create":"Create permission","permission.update":"Update permission","permission.delete":"Delete permission"},K=t=>z[t]||t,I=({actionLabel:t,actionName:l})=>(0,s.jsxs)(p.k,{direction:"column",alignItems:"baseline",gap:1,children:[(0,s.jsx)(D.Z,{textColor:"neutral600",variant:"sigma",children:t}),(0,s.jsx)(D.Z,{textColor:"neutral600",children:l})]});I.propTypes={actionLabel:n.string.isRequired,actionName:n.string.isRequired};const S=({status:t,data:l,formattedDate:m})=>{const{formatMessage:i}=(0,v.Z)();if(t==="loading")return(0,s.jsx)(p.k,{padding:7,justifyContent:"center",alignItems:"center",children:(0,s.jsx)(E.a,{children:"Loading content..."})});const{action:_,user:r,payload:a}=l;return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(P.x,{marginBottom:3,children:(0,s.jsx)(D.Z,{variant:"delta",id:"title",children:i({id:"Settings.permissions.auditLogs.details",defaultMessage:"Log Details"})})}),(0,s.jsxs)(C.r,{gap:4,gridCols:2,paddingTop:4,paddingBottom:4,paddingLeft:6,paddingRight:6,marginBottom:4,background:"neutral100",hasRadius:!0,children:[(0,s.jsx)(I,{actionLabel:i({id:"Settings.permissions.auditLogs.action",defaultMessage:"Action"}),actionName:i({id:`Settings.permissions.auditLogs.${_}`,defaultMessage:K(_)},{model:a?.model})}),(0,s.jsx)(I,{actionLabel:i({id:"Settings.permissions.auditLogs.date",defaultMessage:"Date"}),actionName:m}),(0,s.jsx)(I,{actionLabel:i({id:"Settings.permissions.auditLogs.user",defaultMessage:"User"}),actionName:r?.displayName||"-"}),(0,s.jsx)(I,{actionLabel:i({id:"Settings.permissions.auditLogs.userId",defaultMessage:"User ID"}),actionName:r?.id.toString()||"-"})]}),(0,s.jsx)(u.V,{value:JSON.stringify(a,null,2),disabled:!0,label:i({id:"Settings.permissions.auditLogs.payload",defaultMessage:"Payload"})})]})};S.defaultProps={data:{}},S.propTypes={status:n.oneOf(["idle","loading","error","success"]).isRequired,data:n.shape({action:n.string,date:n.string,payload:n.object,user:n.object}),formattedDate:n.string.isRequired};const b=({handleClose:t,logId:l})=>{const{get:m}=(0,d.useFetchClient)(),i=(0,d.useNotification)(),_=async O=>{const{data:h}=await m(`/admin/audit-logs/${O}`);if(!h)throw new Error("Audit log not found");return h},{data:r,status:a}=(0,Q.useQuery)(["audit-log",l],()=>_(l),{onError(){i({type:"warning",message:{id:"notification.error",defaultMessage:"An error occured"}}),t()}}),o=V(),g=r?o(r.date):"";return(0,s.jsxs)(T.P,{onClose:t,labelledBy:"title",children:[(0,s.jsx)(R.x,{children:(0,s.jsx)(ae.O,{label:g,id:"title",children:(0,s.jsx)(ne.$,{isCurrent:!0,children:g})})}),(0,s.jsx)(A.f,{children:(0,s.jsx)(S,{status:a,data:r,formattedDate:g})})]})};b.propTypes={handleClose:n.func.isRequired,logId:n.string.isRequired};const F=({pagination:t})=>(0,s.jsx)(P.x,{paddingTop:4,children:(0,s.jsxs)(p.k,{alignItems:"flex-end",justifyContent:"space-between",children:[(0,s.jsx)(d.PageSizeURLQuery,{}),(0,s.jsx)(d.PaginationURLQuery,{pagination:t})]})});F.defaultProps={pagination:{pageCount:0,pageSize:50,total:0}},F.propTypes={pagination:n.shape({page:n.number,pageCount:n.number,pageSize:n.number,total:n.number})};const N=({headers:t,rows:l,onOpenModal:m})=>{const{formatMessage:i}=(0,v.Z)(),_=V(),r=({type:a,value:o,model:g})=>a==="date"?_(o):a==="action"?i({id:`Settings.permissions.auditLogs.${o}`,defaultMessage:K(o)},{model:g}):o||"-";return(0,s.jsx)(U.p,{children:l.map(a=>(0,s.jsxs)(c.Tr,{...(0,d.onRowClick)({fn:()=>m(a.id)}),children:[t.map(({key:o,name:g,cellFormatter:O})=>(0,s.jsx)(B.Td,{children:(0,s.jsx)(D.Z,{textColor:"neutral800",children:r({type:o,value:O?O(a[g]):a[g],model:a.payload?.model})})},o)),(0,s.jsx)(B.Td,{...d.stopPropagation,children:(0,s.jsx)(p.k,{justifyContent:"end",children:(0,s.jsx)(Y.h,{onClick:()=>m(a.id),"aria-label":i({id:"app.component.table.view",defaultMessage:"{target} details"},{target:`${a.action} action`}),noBorder:!0,icon:(0,s.jsx)(oe.Z,{})})})})]},a.id))})};N.defaultProps={rows:[]},N.propTypes={headers:n.array.isRequired,rows:n.array,onOpenModal:n.func.isRequired};const x=({value:t,options:l,onChange:m})=>{const{formatMessage:i}=(0,v.Z)(),_=i({id:"Settings.permissions.auditLogs.filter.aria-label",defaultMessage:"Search and select an option to filter"});return(0,s.jsx)(J.hQ,{"aria-label":_,value:t,onChange:m,children:l.map(({label:r,customValue:a})=>(0,s.jsx)(G.O,{value:a,children:r},a))})};x.defaultProps={value:null},x.propTypes={value:n.string,options:n.arrayOf(n.shape({label:n.string.isRequired,customValue:n.string.isRequired}).isRequired).isRequired,onChange:n.func.isRequired};const H=[{intlLabel:{id:"components.FilterOptions.FILTER_TYPES.$eq",defaultMessage:"is"},value:"$eq"},{intlLabel:{id:"components.FilterOptions.FILTER_TYPES.$ne",defaultMessage:"is not"},value:"$ne"}],de=({formatMessage:t,users:l,canReadUsers:m})=>{const i=Object.keys(z).map(r=>({label:t({id:`Settings.permissions.auditLogs.${r}`,defaultMessage:K(r)},{model:void 0}),customValue:r})),_=[{name:"action",metadatas:{customOperators:H,label:t({id:"Settings.permissions.auditLogs.action",defaultMessage:"Action"}),customInput:x,options:i},fieldSchema:{type:"enumeration"}},{name:"date",metadatas:{label:t({id:"Settings.permissions.auditLogs.date",defaultMessage:"Date"})},fieldSchema:{type:"datetime"}}];if(m&&l){const r=o=>o.username?o.username:o.firstname&&o.lastname?t({id:"Settings.permissions.auditLogs.user.fullname",defaultMessage:"{firstname} {lastname}"},{firstname:o.firstname,lastname:o.lastname}):o.email,a=l.map(o=>({label:r(o),customValue:o.id.toString()}));return[..._,{name:"user",metadatas:{customOperators:H,label:t({id:"Settings.permissions.auditLogs.user",defaultMessage:"User"}),options:a,customInput:x},fieldSchema:{type:"relation",mainField:{name:"id"}}}]}return _},le=[{name:"action",key:"action",metadatas:{label:{id:"Settings.permissions.auditLogs.action",defaultMessage:"Action"},sortable:!0}},{name:"date",key:"date",metadatas:{label:{id:"Settings.permissions.auditLogs.date",defaultMessage:"Date"},sortable:!0}},{key:"user",name:"user",metadatas:{label:{id:"Settings.permissions.auditLogs.user",defaultMessage:"User"},sortable:!1},cellFormatter:t=>t?t.displayName:""}],_e=()=>{const{formatMessage:t}=(0,v.Z)(),l=(0,f.useSelector)(y.s),{allowedActions:{canRead:m,canReadUsers:i}}=(0,d.useRBAC)({...l.settings.auditLogs,readUsers:l.settings.users.read}),[{query:_},r]=(0,d.useQueryParams)(),{auditLogs:a,users:o,isLoading:g,hasError:O}=re({canReadAuditLogs:m,canReadUsers:i});(0,d.useFocusWhenNavigate)();const h=de({formatMessage:t,users:o,canReadUsers:i}),j=t({id:"global.auditLogs",defaultMessage:"Audit Logs"}),W=le.map(M=>({...M,metadatas:{...M.metadatas,label:t(M.metadatas.label)}}));return O?(0,s.jsx)(X.A,{children:(0,s.jsx)($.D,{children:(0,s.jsx)(P.x,{paddingTop:8,children:(0,s.jsx)(d.AnErrorOccurred,{})})})}):(0,s.jsxs)(w.o,{"aria-busy":g,children:[(0,s.jsx)(d.SettingsPageTitle,{name:j}),(0,s.jsx)(k.T,{title:j,subtitle:t({id:"Settings.permissions.auditLogs.listview.header.subtitle",defaultMessage:"Logs of all the activities that happened in your environment"})}),(0,s.jsx)(q.Z,{startActions:(0,s.jsx)(ee.F,{displayedFilters:h})}),(0,s.jsxs)($.D,{canRead:m,children:[(0,s.jsx)(d.DynamicTable,{contentType:"Audit logs",headers:W,rows:a?.results||[],withBulkActions:!0,isLoading:g,children:(0,s.jsx)(N,{headers:W,rows:a?.results||[],onOpenModal:M=>r({id:M})})}),(0,s.jsx)(F,{pagination:a?.pagination})]}),_?.id&&(0,s.jsx)(b,{handleClose:()=>r({id:null},"remove"),logId:_.id})]})},me=()=>{const t=(0,f.useSelector)(y.s);return(0,s.jsx)(d.CheckPagePermissions,{permissions:t.settings.auditLogs.main,children:(0,s.jsx)(_e,{})})}},79211:(Z,L,e)=>{e.d(L,{F:()=>C});var s=e(74081),d=e(27279),f=e(93415),y=e(48102),p=e(1180),D=e(57121),E=e(70627),P=e(61020);const C=({displayedFilters:u})=>{const[T,R]=(0,d.useState)(!1),{formatMessage:A}=(0,P.Z)(),U=(0,d.useRef)(),c=()=>{R(B=>!B)};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(f.x,{paddingTop:1,paddingBottom:1,children:[(0,s.jsx)(y.z,{variant:"tertiary",ref:U,startIcon:(0,s.jsx)(D.Z,{}),onClick:c,size:"S",children:A({id:"app.utils.filters",defaultMessage:"Filters"})}),T&&(0,s.jsx)(p.FilterPopoverURLQuery,{displayedFilters:u,isVisible:T,onToggle:c,source:U})]}),(0,s.jsx)(p.FilterListURLQuery,{filtersSchema:u})]})};C.propTypes={displayedFilters:E.arrayOf(E.shape({name:E.string.isRequired,metadatas:E.shape({label:E.string}),fieldSchema:E.shape({type:E.string})})).isRequired}},11266:(Z,L,e)=>{e.d(L,{u:()=>y});var s=e(27279),d=e(1180),f=e(40464);function y(p={},D={}){const{id:E="",...P}=p,{get:C}=(0,d.useFetchClient)(),{data:u,isError:T,isLoading:R,refetch:A}=(0,f.useQuery)(["users",E,P],async()=>{const{data:{data:c}}=await C(`/admin/users/${E}`,{params:P});return c},D);return{users:s.useMemo(()=>{let c=[];return u&&("results"in u?Array.isArray(u.results)&&(c=u.results):c=[u]),c},[u]),pagination:s.useMemo(()=>(u&&"pagination"in u)??null,[u]),isLoading:R,isError:T,refetch:A}}}}]);
